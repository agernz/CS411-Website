{% extends "game/base.html" %}
{% block menu %}
  {% if user.is_authenticated %}
    {% include "game/navbar-logged-in.html" %}
  {% else %}
    {% include "game/navbar-logged-out.html" %}
  {% endif %}
{% endblock %}
{% block content %}
{% if has_won %}
  Raid complete! <a href="{% url 'game-index' %}">Click here to return.</a>
{% elif has_lost %}
  You were defeated. <a href="{% url 'game-index' %}">Click here to return.</a>
{% else %}
  <h4>Monsters</h4>
  <div class="container">
    <div class="row">
      {% for m in monsters %}
      <div class="col-sm">
        <div style="font-weight: bold">
          {{ m.name }} 
        </div>
      Health: {{ m.health }}
      <br>
      Attack: {{ m.attack }}
      <br>
      Defense: {{ m.defense }}
      <br>
      Speed: {{ m.speed }}
      <br>
      {% if no_move and health != 0 and m.health != 0 %}
        <a id="attack-btn" class="btn btn-primary btn-sm" href="{% url 'game-raid-attack' %}?mID={{ m.monsterID }}&pk={{ pk }}">Attack</a>
      {% endif %}
      </div>
      {% endfor %} 
    </div>
  </div>
  <h4>Party</h4>
  <div class="container">
    <div class="row">
      {% for member in party %}
      <div class="col-sm">
        <div style="font-weight: bold">
          {{ member.name }}
        </div>
        Health: {{ member.health }}
      </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

<textarea id="event-log" cols="50" rows="10"></textarea><br/>
<script>
    var raidSocket = new WebSocket('ws://' + window.location.host + 
      '/ws/raid/' + {{ pk }} + '/');

    raidSocket.onmessage = function(e) {
      console.log('onMessage')
      var data = JSON.parse(e.data);
      var pk = data['pk'];
      var events = data['events'];
      document.querySelector('#event-log').value += (events + '\n');
      console.log(pk, events);
    };

    raidSocket.onclose = function(e) {
      console.error('socket closed');
    };


    document.querySelector('#attack-btn').onclick = function(e) {
      console.log('onClick')
      var pk = {{ pk }};
      var events = ["test", "attac"];
      raidSocket.send(JSON.stringify({
          'pk': pk,
          'events': events
      }));
    };
</script>
{% endblock content %}
