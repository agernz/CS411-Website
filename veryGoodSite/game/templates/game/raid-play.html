{% extends "game/base.html" %}
{% block menu %}
  {% if user.is_authenticated %}
    {% include "game/navbar-logged-in.html" %}
  {% else %}
    {% include "game/navbar-logged-out.html" %}
  {% endif %}
{% endblock %}
{% block content %}
{% if has_won %}
  Raid complete! <a href="{% url 'game-index' %}">Click here to return.</a>
{% elif has_lost %}
  You were defeated. <a href="{% url 'game-index' %}">Click here to return.</a>
{% else %}
  <h4>Monsters</h4>
  {% for m in monsters %} 
  {{ m.name }} ({{ m.health }} HP)
    {% if no_move and health != 0 and m.health != 0 %}
    <a id="attack-btn" class="btn btn-primary btn-sm" href="{% url 'game-raid-attack' %}?mID={{ m.monsterID }}&pk={{ pk }}">attack {{ m.name }}</a>
    {% endif %}
  <br>
  {% endfor %} 

  <h4>Party</h4>
  {% for member in party %} 
  {{ member.name }}
  {% if member.health == 0 %}
   (dead)
  {% else %}
   ({{ member.health }} HP)
  {% endif %}

  {% if member.no_move and member.health != 0 %}
  <div class="spinner-border" role="status">
    <span class="sr-only">Waiting...</span>
  </div>
  {% elif member.health != 0 %}
   Ready!
  {% endif %}
  <br>
  {% endfor %} 
{% endif %}

<textarea id="event-log" cols="50" rows="10"></textarea><br/>
<script>
    var raidSocket = new WebSocket('ws://' + window.location.host + 
      '/ws/raid/' + {{ pk }} + '/');

    raidSocket.onmessage = function(e) {
      console.log('onMessage')
      var data = JSON.parse(e.data);
      var pk = data['pk'];
      var events = data['events'];
      document.querySelector('#event-log').value += (events + '\n');
      console.log(pk, events);
    };

    raidSocket.onclose = function(e) {
      console.error('socket closed');
    };


    document.querySelector('#attack-btn').onclick = function(e) {
      console.log('onClick')
      var pk = {{ pk }};
      var events = ["test", "attac"];
      raidSocket.send(JSON.stringify({
          'pk': pk,
          'events': events
      }));
    };
</script>
{% endblock content %}
