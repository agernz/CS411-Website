{% extends "game/base.html" %}
{% block menu %}
  {% if user.is_authenticated %}
    {% include "game/navbar-logged-in.html" %}
  {% else %}
    {% include "game/navbar-logged-out.html" %}
  {% endif %}
{% endblock %}
{% block content %}
{% if has_won %}
  Raid complete! <a href="{% url 'game-index' %}">Click here to return.</a>
{% elif has_lost %}
  You were defeated. <a href="{% url 'game-index' %}">Click here to return.</a>
{% else %}
  <h4>Monsters</h4>
  <div class="container">
    <div class="row">
      {% for m in monsters %}
      <div class="col-sm">
        <div style="font-weight: bold">
          {{ m.name }}
        </div>
      Health: {{ m.health }}
      <br>
      Attack: {{ m.attack }}
      <br>
      Defense: {{ m.defense }}
      <br>
      Speed: {{ m.speed }}
      <br>
      {% if no_move and health != 0 and m.health != 0 %}
        <a id="attack-btn" class="btn btn-primary btn-sm">Attack</a>
      {% endif %}
      </div>
      {% endfor %}
    <div id='monsters' class="row">
    </div>
  </div>
  <br>
  <h4>Party</h4>
  <div class="container">
    <div class="row">
      {% for member in party %}
      <div class="col-sm">
        <div style="font-weight: bold">
          {{ member.name }}
        </div>
        Health: {{ member.health }}
        <br>
        {% if no_move and health != 0 %}
        Status: selecting move
        {% elif not no_move and health != 0 %}
        Status: Ready
        {% elif health == 0 %}
        Status: Dead
        {% endif %}
      </div>
      {% endfor %}
    <div id='party' class="row">
    </div>
  </div>
{% endif %}
<br>
<ul id="event-log">
</ul>
<script>
    var raidSocket = new WebSocket('ws://' + window.location.host +
   window.onload = function() {
      $.ajax({
        type: "GET",
        url: "{% url 'game-raid-update' %}?pk={{ pk }}",
        dataType: "json",
        success: function (response) {
          var monster_data = response.monsters
          var raid_data = response.raid
          var monsterdiv = document.querySelector('#monsters');
          monster_data.forEach(function(elem) {
            var btn = "<a id='attack-btn' class='btn btn-primary btn-sm' onclick='raidUpdate("
              + elem.monsterID + ")'>Attack</a>";
            var content = "<div class='col-sm'><div style='font-weight:bold'>"
              + elem.name + "</div>" + "Health: " + elem.health + "<br>" +
              "Attack: " + elem.attack + "<br>" + "Defense: " + elem.defense +
              "<br>" + "Speed: " + elem.speed + "<br>";
            if (response.no_move && response.health != 0 && elem.health != 0) {
              content += btn;
            }
            monsterdiv.innerHTML += content + "</div>";
          });

          var party_data = response.party
          var partyDiv = document.querySelector('#party');
          party_data.forEach(function(elem) {
            var content = "<div class='col-sm'><div style='font-weight:bold'>"
              + elem.name + "</div>" + "Health: " + elem.health + "<br>";
            if (response.no_move && response.health != 0) {
              content += "Status: selecting move"
            }
            else if (!response.no_move && response.health != 0) {
              content += "Status: Ready"
            }
            else {
              content += "Status: Dead"
            }
            partyDiv.innerHTML += content + "</div>";
          });
        }
      });
    };

    var raidSocket = new WebSocket('ws://' + window.location.host + 
      '/ws/raid/' + {{ pk }} + '/');

    raidSocket.onmessage = function(e) {
      console.log('onMessage');
      var data = JSON.parse(e.data);
      var events = data['events'];
      var eventlog = document.querySelector('#event-log');
      events.forEach(function(elem) {
        eventlog.innerHTML += elem;
      });

      $.ajax({
        type: "GET",
        url: "{% url 'game-raid-update' %}?pk={{ pk }}",
        dataType: "json",
        success: function (response) {
          console.log(response)
        }
      });
    };

    raidSocket.onclose = function(e) {
      console.error('socket closed');
    };


   var raidUpdate = function(mID) {
      $.ajax({
        type: "GET",
        url: "{% url 'game-raid-update' %}?pk={{ pk }}&mID=" + mID,
        dataType: "json",
        success: function (response) {
          console.log(response);
          $('#attack-btn').hide();
          var monster_data = response['monsters']
          var raid_data = response['raid']
          var monsterdiv = document.querySelector('#monsters');
          monster_data.forEach(function(elem) {
            var content = "<div class='col-sm'><div style='font-weight:bold'>"
              + elem['name'] + "</div>" + "Health: " + elem['health'] + "<br>" +
              "Attack: " + elem['attack'] + "<br>" + "Defense: " + elem['defense'] +
              "<br>" + "Speed: " + elem['speed'] + "<br>" + "</div>";
            monsterdiv.innerHTML += content;
          });

        }
      });

      if (events) {
        console.log(events)
        var events = ["test", "attac"];
        raidSocket.send(JSON.stringify({
            'events': events
        }));
      }
    };
</script>
{% endblock content %}
